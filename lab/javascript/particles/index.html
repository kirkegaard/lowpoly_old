<!DOCTYPE html>
<html>
    <head>
        <style type="text/css" media="screen">
            body {
                margin: 0;
                overflow:hidden;
                background-color: #fff;
            }
            .help {
                font-family: arial;
                font-size: 14px;
                position:absolute;
                top: 10px;
                left: 50%;
                width: 200px;
                margin-left: -100px;
                text-align:center;
            }
        </style>
    </head>
<body>
<div class="help">Click to emit particles</div>
<canvas id="canvas"></canvas>

<script src="Utilities.js"></script>
<script src="Vector2.js"></script>
<script>

(function() {

    var WIDTH    = window.innerWidth
      , HEIGHT   = window.innerHeight
      , CANVAS   = document.getElementById('canvas')
      , CTX      = CANVAS.getContext('2d')
      , VELOCITY = {x:0, y:0}
      , MOUSE    = {x:0, y:0}
      , isMouseDown = false
      , MAP      = []
      ;

    var ParticleSystem = new ParticleSystem();

    init();
    requestAnimFrame(render);

    function render() {
        clear();
        update();
        requestAnimFrame(render);
    }

    function init() {
        CANVAS.height = HEIGHT;
        CANVAS.width  = WIDTH;

        document.addEventListener('mousedown', onMouseDown);
        document.addEventListener('mouseup', onMouseUp);
        document.addEventListener('mousemove', onMouseMove);
    }

    function clear() {
        CTX.clearRect(0,0,WIDTH,HEIGHT);
    }

    function onMouseMove(event) {
        VELOCITY.x = (event.clientX - MOUSE.x);
        VELOCITY.y = (event.clientY - MOUSE.y);
        MOUSE.x = event.clientX;
        MOUSE.y = event.clientY;
    }

    function onMouseDown(event) {
        event.preventDefault();
        isMouseDown = true;
    }

    function onMouseUp(event) {
        event.preventDefault();
        isMouseDown = false;
    }

    function update() {
        if(isMouseDown) {
            ParticleSystem.addParticle(MOUSE, VELOCITY);
        }

        ParticleSystem.update(MOUSE);
        ParticleSystem.draw();
    }


    function ParticleSystem() {
        this.particles = [];

        var $this = this;

        this.addParticle = function(mouse, velocity) {
            var m = {
                x: mouse.x,
                y: mouse.y
            };
            var v = {
                x: velocity.x + getRandomFloat(1,3),
                y: velocity.y + getRandomFloat(1,3)
            }

            $this.particles.push(new Particle(m, v));
        }

        this.update = function(mouse) {
            for(var i = 0; i < $this.particles.length; i++) {
                var P = $this.particles[i];
                if(P.isDead) {
                    $this.particles.remove(i);
                } else {
                    P.update(mouse);
                }
            }
        }

        this.draw = function() {
            for(var i = 0; i < $this.particles.length; i++) {
                $this.particles[i].draw();
            }
        }
    }

    function Particle(position, velocity) {
        this.pos = {x:0, y:0};
        this.vel = {x:0, y:0};
        this.acc = {x:0, y:0};
        this.dec = {
            x:getRandomFloat(0.5,0.9),
            y:getRandomFloat(0.5,0.9)
        };

        this.isDead = false;
        this.age = 0;
        this.life = getRandomInt(50, 250);
        this.radius = 5 + getRandomFloat(0, 0.1);
        this.radiusDest = 3;

        var $this = this;

        // Constructor
        this.init = (function(position, velocity) {
            $this.pos = position;
            $this.vel = velocity;
        })(position, velocity);

        this.draw = function() {
            CTX.beginPath();
            CTX.arc($this.pos.x, $this.pos.y, $this.radius, Math.PI * 2, false);
            CTX.closePath();
            CTX.fillStyle = 'black';
            CTX.fill();
        }

        this.update = function() {
            // $this.vel.x += $this.acc.x;
            // $this.vel.y += $this.acc.y;

            var maxVel = $this.radius + 0.025;

            $this.pos.x += $this.vel.x;
            $this.pos.y += $this.vel.y;

            $this.vel.x *= $this.dec.x;
            $this.vel.y *= $this.dec.y;

            $this.radius -= $this.radius * 0.02;

            $this.age++;
            if($this.age > $this.life) {
                $this.isDead = true;
            }
        }
    }

})();
</script>
</body>
</html>
